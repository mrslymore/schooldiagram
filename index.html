<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Classroom Layout Tool</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      overflow: hidden;
    }
    #toolbar {
      background: #eee;
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #canvas {
      position: relative;
      width: 100%;
      height: calc(100vh - 50px);
      background: #f9f9f9;
      overflow: auto;
    }
    .room {
      position: absolute;
      border: 2px solid #333;
      background: #fff;
      padding: 8px;
      min-width: 60px;
      min-height: 60px;
      resize: both;
      overflow: auto;
      box-sizing: border-box;
      user-select: none;
      white-space: pre-wrap;
    }
    .room.selected {
      border-color: red;
    }
    .resizer {
      width: 10px;
      height: 10px;
      background: gray;
      position: absolute;
      right: 0;
      bottom: 0;
      cursor: se-resize;
    }
    .zoom-wrapper {
      transform-origin: 0 0;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <button onclick="addRoom()">Add Room</button>
    <button onclick="editRooms()">Edit Selected</button>
    <button onclick="deleteRooms()">Delete Selected</button>
    <button onclick="undo()">Undo</button>
    <button onclick="redo()">Redo</button>
    <button onclick="loadLayout()">Load Layout</button>
    <button onclick="exportPNG()">Export PNG</button>
    <button onclick="zoomIn()">Zoom In</button>
    <button onclick="zoomOut()">Zoom Out</button>
  </div>

  <div id="canvas">
    <div id="zoomContainer" class="zoom-wrapper"></div>
  </div>

  <!-- Room Settings Modal -->
  <div id="roomSettings" style="display:none; position:fixed; top:20%; left:30%; background:white; border:1px solid #000; padding:20px;">
    <h3>Edit Rooms</h3>
    <label>Room Text:<br><textarea id="roomText" rows="4" cols="30"></textarea></label><br><br>
    <label>Color: <input type="color" id="roomColor"></label><br><br>
    <label>Font Size: <input type="number" id="roomFontSize" value="16"></label><br><br>
    <button onclick="applyRoomSettings()">Apply</button>
    <button onclick="closeRoomSettings()">Cancel</button>
  </div>

  <script>
    let zoomLevel = 1;
    let selectedRooms = new Set();
    let history = [];
    let future = [];

    const canvas = document.getElementById('zoomContainer');
    const roomSettings = document.getElementById('roomSettings');
    let isDragging = false, offsetX = 0, offsetY = 0, draggedRooms = [];

    function recordHistory() {
      history.push(canvas.innerHTML);
      if (history.length > 100) history.shift();
      future = [];
    }

    function undo() {
      if (history.length > 0) {
        future.push(canvas.innerHTML);
        canvas.innerHTML = history.pop();
        setupEventListeners();
      }
    }

    function redo() {
      if (future.length > 0) {
        history.push(canvas.innerHTML);
        canvas.innerHTML = future.pop();
        setupEventListeners();
      }
    }

    function addRoom() {
      const div = document.createElement('div');
      div.className = 'room';
      div.contentEditable = false;
      div.style.top = '100px';
      div.style.left = '100px';
      div.style.fontSize = '16px';
      div.textContent = 'New Room';
      div.appendChild(createResizer());
      canvas.appendChild(div);
      makeDraggable(div);
      div.addEventListener('click', e => toggleSelectRoom(e, div));
      recordHistory();
    }

    function createResizer() {
      const resizer = document.createElement('div');
      resizer.className = 'resizer';
      resizer.addEventListener('mousedown', e => {
        e.stopPropagation();
        const room = resizer.parentElement;
        const startX = e.clientX;
        const startY = e.clientY;
        const startWidth = room.offsetWidth;
        const startHeight = room.offsetHeight;
        const onMove = (e) => {
          room.style.width = startWidth + (e.clientX - startX) + 'px';
          room.style.height = startHeight + (e.clientY - startY) + 'px';
        };
        const onUp = () => {
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
          recordHistory();
        };
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });
      return resizer;
    }

    function makeDraggable(room) {
      room.addEventListener('mousedown', e => {
        if (e.target.classList.contains('resizer')) return;

        isDragging = true;
        draggedRooms = Array.from(selectedRooms);
        offsetX = e.clientX;
        offsetY = e.clientY;

        const positions = draggedRooms.map(r => ({
          el: r,
          x: parseInt(r.style.left),
          y: parseInt(r.style.top)
        }));

        function onMouseMove(e) {
          const dx = e.clientX - offsetX;
          const dy = e.clientY - offsetY;
          positions.forEach(p => {
            p.el.style.left = p.x + dx + 'px';
            p.el.style.top = p.y + dy + 'px';
          });
        }

        function onMouseUp() {
          isDragging = false;
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
          recordHistory();
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });
    }

    function toggleSelectRoom(e, room) {
      if (e.shiftKey) {
        if (selectedRooms.has(room)) {
          selectedRooms.delete(room);
          room.classList.remove('selected');
        } else {
          selectedRooms.add(room);
          room.classList.add('selected');
        }
      } else {
        selectedRooms.forEach(r => r.classList.remove('selected'));
        selectedRooms.clear();
        selectedRooms.add(room);
        room.classList.add('selected');
      }
    }

    function editRooms() {
      if (selectedRooms.size === 0) return alert("Select at least one room.");
      const first = selectedRooms.values().next().value;
      document.getElementById('roomText').value = first.textContent.trim();
      document.getElementById('roomColor').value = rgbToHex(first.style.backgroundColor || "#ffffff");
      document.getElementById('roomFontSize').value = parseInt(first.style.fontSize || "16");
      roomSettings.style.display = 'block';
    }

    function applyRoomSettings() {
      const text = document.getElementById('roomText').value;
      const color = document.getElementById('roomColor').value;
      const fontSize = document.getElementById('roomFontSize').value + 'px';

      selectedRooms.forEach(room => {
        const resizer = room.querySelector('.resizer');
        room.innerHTML = '';
        room.append(document.createTextNode(text));
        room.appendChild(resizer);
        room.style.backgroundColor = color;
        room.style.fontSize = fontSize;
      });

      roomSettings.style.display = 'none';
      recordHistory();
    }

    function deleteRooms() {
      selectedRooms.forEach(r => r.remove());
      selectedRooms.clear();
      recordHistory();
    }

    function closeRoomSettings() {
      roomSettings.style.display = 'none';
    }

    function rgbToHex(rgb) {
      if (!rgb || !rgb.includes('rgb')) return rgb;
      const parts = rgb.match(/\d+/g).map(Number);
      return '#' + parts.map(p => p.toString(16).padStart(2, '0')).join('');
    }

    function loadLayout() {
      const layout = prompt("Paste saved layout:");
      if (layout) {
        history.push(canvas.innerHTML);
        canvas.innerHTML = layout;
        setupEventListeners();
      }
    }

    function setupEventListeners() {
      selectedRooms.clear();
      document.querySelectorAll('.room').forEach(room => {
        room.appendChild(createResizer());
        makeDraggable(room);
        room.addEventListener('click', e => toggleSelectRoom(e, room));
      });
    }

    function exportPNG() {
      html2canvas(document.getElementById('canvas')).then(canvasEl => {
        const link = document.createElement('a');
        link.download = 'layout.png';
        link.href = canvasEl.toDataURL();
        link.click();
      });
    }

    function zoomIn() {
      zoomLevel *= 1.2;
      document.getElementById('zoomContainer').style.transform = `scale(${zoomLevel})`;
    }

    function zoomOut() {
      zoomLevel /= 1.2;
      document.getElementById('zoomContainer').style.transform = `scale(${zoomLevel})`;
    }
  </script>

  <!-- Add html2canvas for PNG export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</body>
</html>
